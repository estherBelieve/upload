!function(e,t){"object"==typeof module&&"object"==typeof module.exports?module.exports=e.document?t.call(e):function(n){if(!n.document)throw new Error("upload requires a window with a document");return t.call(e)}:t.call(e)}(this,function(){function e(t){return this instanceof e?(this.init(t),this):new e(t)}var t=this,n=e.tools={},o=n.each=function(e,t,n){var o=Array.prototype.slice.call(arguments,3);if(e)if(e.length===+e.length){var i;for(i=0;i<e.length;i++)t.apply(n,[e[i],i].concat(o))}else for(var r in e)t.apply(n,[e[r],r].concat(o))},i=n.cloneObject=function(e){var t={};return o(e,function(n,o){e.hasOwnProperty(o)&&(t[o]=n)}),t},r=n.extend=function(e){return o(Array.prototype.slice.call(arguments,1),function(t){o(t,function(n,o){t.hasOwnProperty(o)&&(e[o]=n)})}),e},a=n.preExtend=function(e){return o(Array.prototype.slice.call(arguments,1),function(t){o(t,function(n,o){t.hasOwnProperty(o)&&e.hasOwnProperty(o)&&(e[o]=n)})}),e};n.merge=function(e,t){var n=Array.prototype.slice.call(arguments,0);return n.unshift({}),r.apply(null,n)};return e.prototype={init:function(e){var t=this;if(e=i(e),t.options={id:"",url:"",loadFiles:[],success:"",error:"",progress:"",dragElement:"",dragClass:"",ext:".png,.jpg,.jpeg",size:"",validateCallBack:""},t.options=a(t.options,e),!e.id||!e.url)throw new Error("缺少必要参数！");t.files=[],t.xhr=new XMLHttpRequest,t.formData=new FormData,t.url=e.url,t.renderUploadElement(),t.index=0,t.indexContainer=[],t.initAjaxEvent(),t.initEvent(),t.options.loadFiles.length&&t.renderSuccessCallback({data:t.options.loadFiles},"load")},initAjaxEvent:function(){var e=this,t=e.xhr;e.xhr.upload.addEventListener("progress",function(t){e.progress.call(e,t)},!1),e.addEvent(t,"load",function(t){e.success.call(e,t)}),e.addEvent(t,"error",function(t){e.error.call(e,t)}),e.addEvent(t,"readystatechange",function(e){})},initEvent:function(){var e=this;if(e.options.dragElement){var t=e.options.dragElement,n=e.options.dragClass||"";e.addEvent(t,"dragover",function(e){e.preventDefault(),e.stopPropagation(),n&&t.classList.add(n)}),e.addEvent(t,"dragleave",function(e){e.preventDefault(),e.stopPropagation(),n&&t.classList.remove(n)}),e.addEvent(t,"drop",function(t){t.preventDefault(),t.stopPropagation(),e.sendFile(t.dataTransfer.files[0])})}if(e.options.element){var o=e.options.element;e.addEvent(o,"change",function(t){e.sendFile()})}},sendFile:function(e){var t=this;if(e=e||null,!t.validateFile(e))return void(t.validateInfo&&(t.options.validateCallBack?t.options.validateCallBack(t.validateInfo):alert(t.validateInfo)));var n="files_";if(e)var o=[e];else var o=t.element.files;var i=t.formData;if(i.forEach)i.forEach(function(e,t){i.has(t)&&i.delete(t)});else{for(var r in t.indexContainer){var a=t.indexContainer[r],s=n+a;i.has(s)&&i.delete(s)}t.indexContainer=[]}for(var l=0;l<o.length;l++)t.indexContainer.push(t.index),i.append(n+t.index,o[0]),t.index++;this.send()},validateFile:function(e){var t=this;if(e=e?e:t.element.files[0]){if(t.options.size&&!t.validateSize(e))return t.validateInfo="文件大小不符合要求！",!1;if(t.options.ext&&!t.validateExt(e))return t.validateInfo="文件格式不符合要求！",!1}return!0},validateSize:function(e){var t=this,n=e.size,o=t.options.size.toLowerCase(),i=/[gmkb]b?/.exec(o);if(0===i.length)return!1;var r=i[0].charAt(0);if(o=parseInt(o.split(r)[0]),isNaN(o))return!1;switch(r){case"g":o*=1073741824;break;case"m":o*=1048576;break;case"k":o*=1024}return!(o<n)},validateExt:function(e){for(var t=this,n="."+e.name.split(".")[e.name.split(".").length-1],o=t.options.ext.split(","),i=0;i<o.length;i++)o[i].replace(/( )/g,"");return o.indexOf(n)!=-1},send:function(){this.xhr.open("POST",this.url),this.xhr.send(this.formData)},addEvent:function(e,t,n){e.addEventListener(t,n,!1)},success:function(e){var t=e.target.response,n=JSON.parse(t);this.renderSuccessCallback(n),this.options.success&&this.options.success(n)},error:function(e){this.options.error&&this.options.error(e)},progress:function(e){var t=100*e.loaded/e.total;t=t.toFixed(2),t+="%",this.options.progress&&this.options.progress(t)},cancle:function(e){},getFiles:function(){return this.files},setOptionsLog:function(e,t){var n=this;"[object Array]"!=Object.prototype.toString.call(n.logArray)&&(n.logArray=[]),n.logArray.push({active:e,file:t})},getOptionsLog:function(){return this.logArray||[]},getId:function(e){return t.document.getElementById(e)},getClass:function(e){return t.document.getElementsByClassName(e)},getElements:function(e){return t.document.querySelector(e)},css:function(e,t){return r(e.style,t),e},renderUploadElement:function(){var e=this;e.options.uploadContainer=e.getId(e.options.id);var n=t.document.createElement("a");e.css(n,{display:"inline-block",width:"100px",height:"100px",border:"1px solid #eeeeee",backgroundImage:'url("../img/add.jpg")',backgroundSize:"cover",borderRadius:"5px",position:"relative",overflow:"hidden",cursor:"pointer",margin:"5px"}),n.onmouseover=function(){e.css(n,{opacity:"0.8",filter:"alpha(opacity=80)"})},n.onmouseout=function(){e.css(n,{opacity:"1",filter:"alpha(opacity=100)"})};var o=t.document.createElement("input");o.setAttribute("type","file"),e.css(o,{position:"absolute",right:"0",top:"0",fontSize:"99px",opacity:"0",outline:"none",cursor:"pointer",filter:"alpha(opacity=0)"}),n.appendChild(o),e.options.uploadContainer.appendChild(n),e.element=e.options.element=o},renderSuccessCallback:function(e,n){var o=this;if(e.data.length)for(var i=0;i<e.data.length;i++){var r=e.data[i],a=t.document.createElement("div");o.css(a,{display:"inline-block",width:"100px",height:"100px",border:"1px solid #eeeeee",borderRadius:"5px",position:"relative",overflow:"hidden",cursor:"pointer",margin:"5px"});var s=t.document.createElement("img");s.setAttribute("src","../img/loading.gif"),o.preLoadImage(r,function(){s.setAttribute("src",r),o.files.push(r),n?o.setOptionsLog("load",r):o.setOptionsLog("add",r);var e=t.document.createElement("div");e.innerText="删除",o.css(e,{width:"100%",height:"20px",position:"absolute",left:"0",bottom:"0px",textAlign:"center",backgroundColor:"black",opacity:"0.5",color:"white",fontSize:"12px",fontWeight:"bold",lineHeight:"20px"}),a.appendChild(e),e.onclick=function(e){o.options.uploadContainer.removeChild(a),o.files.splice(o.files.indexOf(r),1),o.setOptionsLog("cancle",r),o.cancle.call(o,a)}}),o.css(s,{width:"100%",height:"100%"}),a.appendChild(s),o.options.uploadContainer.insertBefore(a,o.element.parentNode)}},preLoadImage:function(e,n){var o=t.document.createElement("img");o.src=e,o.onload=n}},"function"==typeof define&&define.amd&&define("upload",[],function(){return e}),t.Upload=e,e});