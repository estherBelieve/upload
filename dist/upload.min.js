!function(){function e(t){return this instanceof e?(this.init(t),this):new e(t)}var t=this,n=e.tools={},i=n.each=function(e,t,n){var i=Array.prototype.slice.call(arguments,3);if(e)if(e.length===+e.length){var o;for(o=0;o<e.length;o++)t.apply(n,[e[o],o].concat(i))}else for(var r in e)t.apply(n,[e[r],r].concat(i))},o=n.cloneObject=function(e){var t={};return i(e,function(n,i){e.hasOwnProperty(i)&&(t[i]=n)}),t},r=n.extend=function(e){return i(Array.prototype.slice.call(arguments,1),function(t){i(t,function(n,i){t.hasOwnProperty(i)&&(e[i]=n)})}),e},a=n.preExtend=function(e){return i(Array.prototype.slice.call(arguments,1),function(t){i(t,function(n,i){t.hasOwnProperty(i)&&e.hasOwnProperty(i)&&(e[i]=n)})}),e};n.merge=function(e,t){var n=Array.prototype.slice.call(arguments,0);return n.unshift({}),r.apply(null,n)};return e.prototype={init:function(e){var t=this;if(e=o(e),t.options={id:"",url:"",loadFiles:[],success:"",error:"",progress:"",dragElement:"",dragClass:"",ext:".png,.jpg,.jpeg",size:"",validateCallBack:""},t.options=a(t.options,e),!e.id||!e.url)throw new Error("缺少必要参数！");t.files=[],t.xhr=new XMLHttpRequest,t.formData=new FormData,t.url=e.url,t.renderUploadElement(),t.index=0,t.indexContainer=[],t.initAjaxEvent(),t.initEvent(),t.options.loadFiles.length&&t.renderSuccessCallback({data:t.options.loadFiles},"load")},initAjaxEvent:function(){var e=this,t=e.xhr;e.xhr.upload.addEventListener("progress",function(t){e.progress.call(e,t)},!1),e.addEvent(t,"load",function(t){e.success.call(e,t)}),e.addEvent(t,"error",function(t){e.error.call(e,t)}),e.addEvent(t,"readystatechange",function(e){})},initEvent:function(){var e=this;if(e.options.dragElement){var t=e.options.dragElement,n=e.options.dragClass||"";e.addEvent(t,"dragover",function(e){e.preventDefault(),e.stopPropagation(),n&&t.classList.add(n)}),e.addEvent(t,"dragleave",function(e){e.preventDefault(),e.stopPropagation(),n&&t.classList.remove(n)}),e.addEvent(t,"drop",function(t){t.preventDefault(),t.stopPropagation(),e.sendFile(t.dataTransfer.files[0])})}if(e.options.element){var i=e.options.element;e.addEvent(i,"change",function(t){e.sendFile()})}},sendFile:function(e){var t=this;if(e=e||null,!t.validateFile(e))return void(t.validateInfo&&(t.options.validateCallBack?t.options.validateCallBack(t.validateInfo):alert(t.validateInfo)));var n="files_";if(e)var i=[e];else var i=t.element.files;var o=t.formData;if(o.forEach)o.forEach(function(e,t){o.has(t)&&o.delete(t)});else{for(var r in t.indexContainer){var a=t.indexContainer[r],s=n+a;o.has(s)&&o.delete(s)}t.indexContainer=[]}for(var l=0;l<i.length;l++)t.indexContainer.push(t.index),o.append(n+t.index,i[0]),t.index++;this.send()},validateFile:function(e){var t=this;if(e=e?e:t.element.files[0]){if(t.options.size&&!t.validateSize(e))return t.validateInfo="文件大小不符合要求！",!1;if(t.options.ext&&!t.validateExt(e))return t.validateInfo="文件格式不符合要求！",!1}return!0},validateSize:function(e){var t=this,n=e.size,i=t.options.size.toLowerCase(),o=/[gmkb]b?/.exec(i);if(0===o.length)return!1;var r=o[0].charAt(0);if(i=parseInt(i.split(r)[0]),isNaN(i))return!1;switch(r){case"g":i*=1073741824;break;case"m":i*=1048576;break;case"k":i*=1024}return!(i<n)},validateExt:function(e){for(var t=this,n="."+e.name.split(".")[e.name.split(".").length-1],i=t.options.ext.split(","),o=0;o<i.length;o++)i[o].replace(/( )/g,"");return i.indexOf(n)!=-1},send:function(){this.xhr.open("POST",this.url),this.xhr.send(this.formData)},addEvent:function(e,t,n){e.addEventListener(t,n,!1)},success:function(e){var t=e.target.response,n=JSON.parse(t);this.renderSuccessCallback(n),this.options.success&&this.options.success(n)},error:function(e){this.options.error&&this.options.error(e)},progress:function(e){var t=100*e.loaded/e.total;t=t.toFixed(2),t+="%",this.options.progress&&this.options.progress(t)},cancle:function(e){},getFiles:function(){return this.files},setOptionsLog:function(e,t){var n=this;"[object Array]"!=Object.prototype.toString.call(n.logArray)&&(n.logArray=[]),n.logArray.push({active:e,file:t})},getOptionsLog:function(){return this.logArray||[]},getId:function(e){return t.document.getElementById(e)},getClass:function(e){return t.document.getElementsByClassName(e)},getElements:function(e){return t.document.querySelector(e)},css:function(e,t){return r(e.style,t),e},renderUploadElement:function(){var e=this;e.options.uploadContainer=e.getId(e.options.id);var n=t.document.createElement("a");e.css(n,{display:"inline-block",width:"100px",height:"100px",border:"1px solid #eeeeee",backgroundImage:'url("../img/add.jpg")',backgroundSize:"cover",borderRadius:"5px",position:"relative",overflow:"hidden",cursor:"pointer",margin:"5px"}),n.onmouseover=function(){e.css(n,{opacity:"0.8",filter:"alpha(opacity=80)"})},n.onmouseout=function(){e.css(n,{opacity:"1",filter:"alpha(opacity=100)"})};var i=t.document.createElement("input");i.setAttribute("type","file"),e.css(i,{position:"absolute",right:"0",top:"0",fontSize:"99px",opacity:"0",outline:"none",cursor:"pointer",filter:"alpha(opacity=0)"}),n.appendChild(i),e.options.uploadContainer.appendChild(n),e.element=e.options.element=i},renderSuccessCallback:function(e,n){var i=this;if(e.data.length)for(var o=0;o<e.data.length;o++){var r=e.data[o],a=t.document.createElement("div");i.css(a,{display:"inline-block",width:"100px",height:"100px",border:"1px solid #eeeeee",borderRadius:"5px",position:"relative",overflow:"hidden",cursor:"pointer",margin:"5px"});var s=t.document.createElement("img");s.setAttribute("src","../img/loading.gif"),i.preLoadImage(r,function(){s.setAttribute("src",r),i.files.push(r),n?i.setOptionsLog("load",r):i.setOptionsLog("add",r);var e=t.document.createElement("div");e.innerText="删除",i.css(e,{width:"100%",height:"20px",position:"absolute",left:"0",bottom:"0px",textAlign:"center",backgroundColor:"black",opacity:"0.5",color:"white",fontSize:"12px",fontWeight:"bold",lineHeight:"20px"}),a.appendChild(e),e.onclick=function(e){i.options.uploadContainer.removeChild(a),i.files.splice(i.files.indexOf(r),1),i.setOptionsLog("cancle",r),i.cancle.call(i,a)}}),i.css(s,{width:"100%",height:"100%"}),a.appendChild(s),i.options.uploadContainer.insertBefore(a,i.element.parentNode)}},preLoadImage:function(e,n){var i=t.document.createElement("img");i.src=e,i.onload=n}},"function"==typeof define&&define.amd&&define("upload",[],function(){return e}),t.Upload=e,e}();