(function(){function e(t){return this instanceof e?(this.init(t),this):new e(t)}var t=this,n=e.tools={},i=n.each=function(e,t,n){var i=Array.prototype.slice.call(arguments,3);if(e)if(e.length===+e.length){var a;for(a=0;a<e.length;a++)t.apply(n,[e[a],a].concat(i))}else for(var r in e)t.apply(n,[e[r],r].concat(i))},a=n.cloneObject=function(e){var t={};return i(e,function(n,i){e.hasOwnProperty(i)&&(t[i]=n)}),t},r=n.extend=function(e){return i(Array.prototype.slice.call(arguments,1),function(t){i(t,function(n,i){t.hasOwnProperty(i)&&(e[i]=n)})}),e};n.merge=function(e,t){var n=Array.prototype.slice.call(arguments,0);return n.unshift({}),r.apply(null,n)};e.prototype={init:function(e){var t=this;if(e=a(e),!e.element||!e.url)throw"缺少必要参数！";t.xhr=new XMLHttpRequest,t.formData=new FormData,t.element=e.element,t.url=e.url,t.options=e,t.index=0,t.indexContainer=[],t.initAjaxEvent(),t.initEvent()},initAjaxEvent:function(){var e=this,t=e.xhr;e.xhr.upload.addEventListener("progress",function(t){e.progress.call(e,t)},!1),e.addEvent(t,"load",function(t){e.success.call(e,t)}),e.addEvent(t,"error",function(t){e.error.call(e,t)}),e.addEvent(t,"readystatechange",function(e){})},initEvent:function(){var e=this;if(e.options.dragElement){var t=e.options.dragElement,n=e.options.dragClass||"";e.addEvent(t,"dragover",function(e){e.preventDefault(),e.stopPropagation(),n&&t.classList.add(n)}),e.addEvent(t,"dragleave",function(e){e.preventDefault(),e.stopPropagation(),n&&t.classList.remove(n)}),e.addEvent(t,"drop",function(t){t.preventDefault(),t.stopPropagation(),e.sendFile(t.dataTransfer.files[0])})}if(e.options.element){var i=e.options.element;e.addEvent(i,"change",function(t){e.sendFile()})}},sendFile:function(e){var t=this;if(e=e||null,!t.validateFile(e))return void(t.validateInfo&&(t.options.validateCallBack?t.options.validateCallBack(t.validateInfo):alert(t.validateInfo)));var n="files_";if(e)var i=[e];else var i=t.element.files;var a=t.formData;if(a.forEach)a.forEach(function(e,t){a.has(t)&&a.delete(t)});else{for(var r in t.indexContainer){var o=t.indexContainer[r],s=n+o;a.has(s)&&a.delete(s)}t.indexContainer=[]}for(var l=0;l<i.length;l++)t.indexContainer.push(t.index),a.append(n+t.index,i[0]),t.index++;this.send()},validateFile:function(e){var t=this;if(e=e?e:t.element.files[0]){if(t.options.size&&!t.validateSize(e))return t.validateInfo="文件大小不符合要求！",!1;if(t.options.ext&&!t.validateExt(e))return t.validateInfo="文件格式不符合要求！",!1}return!0},validateSize:function(e){var t=this,n=e.size,i=t.options.size.toLowerCase(),a=/[gmkb]b?/.exec(i);if(0===a.length)return!1;var r=a[0].charAt(0);if(i=parseInt(i.split(r)[0]),isNaN(i))return!1;switch(r){case"g":i*=1073741824;break;case"m":i*=1048576;break;case"k":i*=1024}return!(i<n)},validateExt:function(e){for(var t=this,n="."+e.name.split(".")[e.name.split(".").length-1],i=t.options.ext.split(","),a=0;a<i.length;a++)i[a].replace(/( )/g,"");return i.indexOf(n)!=-1},send:function(){this.xhr.open("POST",this.url),this.xhr.send(this.formData)},addEvent:function(e,t,n){e.addEventListener(t,n,!1)},success:function(e){var t=e.target.response,n=JSON.parse(t);if(this.options.success)this.options.success(n);else if(this.options.uploadContainer){var i=this.options.uploadContainer;if(n.data.length)for(var a=0;a<n.data.length;a++){var r=n.data[a];if(this.options.uploadTemp){var o=this.options.uploadTemp.replace(/(\{src\})/,r);i.innerHTML+=o}}}},error:function(e){this.options.error&&this.options.error(e)},progress:function(e){var t=100*e.loaded/e.total;t=t.toFixed(2),t+="%",this.options.progress&&this.options.progress(t)},getId:function(e){return t.document.getElementById(e)},getClass:function(e){return t.document.getElementsByClassName(e)},getElements:function(e){return t.document.querySelector(e)}},t.Upload=Upload}).call(this);